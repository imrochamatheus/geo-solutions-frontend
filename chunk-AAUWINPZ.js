import"./chunk-DJZWIYSC.js";import{a as se,b as le}from"./chunk-35HT5RMS.js";import"./chunk-7733DRMK.js";import{a as ce}from"./chunk-HM63VKUO.js";import{f as y,i as ne}from"./chunk-HJMF6YSB.js";import"./chunk-4YRY4IP2.js";import"./chunk-LWWUDTLH.js";import{b as ae}from"./chunk-MH2CX7EV.js";import{c as ie,e as oe}from"./chunk-U4MZYTGD.js";import{c as q,d as D,e as H,f as U,j as W,k as G,l as L,m as Q,n as J,o as K,p as X,q as Y,s as Z,t as ee,u as te,w as re}from"./chunk-57VEO5ZA.js";import"./chunk-AJCXHZIR.js";import{b as $}from"./chunk-KCOFYTGJ.js";import{n as P,o as z,s as R}from"./chunk-JOQ4QRTS.js";import{Bb as s,Cb as A,Da as l,Db as I,Ea as p,J as V,Jb as F,Kb as j,L as B,P as N,U as M,Ya as g,_ as k,_a as c,gb as a,hb as o,ia as S,ib as m,ja as C,k as _,mb as E,o as T,qb as h,rb as v,w,za as O}from"./chunk-URY3LSMO.js";import"./chunk-TMC7WMLO.js";var x=function(i){return i[i.SquareMeter=0]="SquareMeter",i[i.Hectare=1]="Hectare",i}(x||{});var de=(()=>{class i{http;baseUrl="https://viacep.com.br/ws";constructor(e){this.http=e}getCityIbgeIdByCep(e){let t=e.replace(/\D/g,"");return t.length!==8?_(null):this.http.get(`${this.baseUrl}/${t}/json`).pipe(T(r=>!r||r.ibge===void 0?null:parseInt(r.ibge,10)),w(r=>(console.error("Erro ao consultar ViaCEP:",r),_(null))))}static \u0275fac=function(t){return new(t||i)(M($))};static \u0275prov=N({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function ge(i,u){if(i&1){let e=E();a(0,"button",39),h("click",function(){S(e);let r=v().$implicit,n=v();return C(n.onWppButtonClick(r))}),s(1,"Fale conosco no WhatsApp"),o()}}function fe(i,u){if(i&1&&(a(0,"div",32)(1,"div",33),m(2,"i",34),a(3,"h4",35),s(4),o(),m(5,"p",36),o(),a(6,"div",37),g(7,ge,2,0,"button",38),o()()),i&2){let e=u.$implicit,t=v();l(4),A(e.summary),l(),c("innerHTML",e.detail,O),l(2),c("ngIf",t.redirectWpp)}}function he(i,u){if(i&1&&(a(0,"option",23),s(1),o()),i&2){let e=u.$implicit;c("ngValue",e.id),l(),I(" ",e.name," ")}}function ve(i,u){i&1&&(a(0,"option",23),s(1,"Selecione o detalhe do servi\xE7o"),o()),i&2&&c("ngValue",0)}function be(i,u){if(i&1&&(a(0,"option",23),s(1),o()),i&2){let e=u.$implicit;c("ngValue",e.name),l(),I(" ",e.name," ")}}function Se(i,u){i&1&&(a(0,"div",28)(1,"label",40),s(2,"Confronta\xE7\xF5es"),o(),m(3,"input",41),o())}function Ce(i,u){if(i&1){let e=E();a(0,"div",42)(1,"button",43),h("click",function(){S(e);let r=v();return C(r.processarCalculo())}),s(2," Processar C\xE1lculo "),o(),a(3,"button",44),h("click",function(){S(e);let r=v();return C(r.gerarOrcamento())}),s(4," Gerar Or\xE7amento "),o()()}}var De=(()=>{class i{route;fb;budgetService;authService;messageService;viaCepService;router;form;serviceTypes=[];intentions=[];selectedServiceTypeId=null;selectedIntentionServiceId=null;EUnitOfMeasure=x;mostrarConfrontacoes=!1;redirectWpp=!1;readonly=!1;ngOnInit(){this.getServiceTypes();let e=this.route.snapshot.paramMap.get("id");e?(this.readonly=!0,this.getBudgetById(e)):(this.getServiceTypes(),this.form.get("servico")?.valueChanges.subscribe(t=>{let r=this.serviceTypes.find(d=>d.id===t);this.intentions=r?.intentionServices||[];let n=this.form.get("detalheServico");this.intentions.length>0?(n?.enable(),n?.setValue(this.intentions[0].name)):(n?.setValue(0),n?.disable())}),this.form.get("detalheServico")?.valueChanges.subscribe(t=>{let r=this.intentions.find(n=>n.name===t);this.mostrarConfrontacoes=r?.urbanConfrontation||r?.ruralConfrontation||!1,this.mostrarConfrontacoes?this.form.get("confrontations")?.enable():(this.form.get("confrontations")?.reset(),this.form.get("confrontations")?.disable())}))}constructor(e,t,r,n,d,f,b){this.route=e,this.fb=t,this.budgetService=r,this.authService=n,this.messageService=d,this.viaCepService=f,this.router=b,this.form=this.fb.group({cep:[""],bairro:[{value:"",disabled:!0},D.required],logradouro:[{value:"",disabled:!0}],cidade:[{value:"",disabled:!0}],estado:[{value:"",disabled:!0}],numero:[{value:null,disabled:!0}],complemento:[{value:"",disabled:!0}],area:[0],servico:[0],detalheServico:[{value:0,disabled:!0}],unitOfMeasure:[x.SquareMeter],confrontations:[0],price:[""]})}getServiceTypes(){this.budgetService.getAllServiceTypes().subscribe(e=>{this.serviceTypes=e})}getAddressByCep(){let e=this.form.get("cep")?.value;e&&this.viaCepService.getCityIbgeIdByCep(e).subscribe({next:t=>{if(!t){this.showNoCoverageModal();return}this.budgetService.checkCityCoverageByIbge(t.toString()).subscribe({next:r=>{if(!r){this.showNoCoverageModal();return}this.form.get("numero")?.enable(),this.form.get("bairro")?.enable(),this.form.get("logradouro")?.enable(),this.form.get("cidade")?.enable(),this.form.get("estado")?.enable(),this.form.get("complemento")?.enable(),this.budgetService.fetchAddressByCep(e).subscribe({next:n=>{this.form.patchValue({logradouro:n.street,bairro:n.neighborhood,cidade:n.city,estado:n.state})},error:n=>{console.error("Erro ao buscar o endere\xE7o:",n),this.showToast("error","Erro","N\xE3o foi poss\xEDvel buscar o endere\xE7o. Verifique o CEP e tente novamente.")}})},error:r=>{console.error("Erro ao verificar cobertura:",r),this.showNoCoverageModal()}})},error:t=>{console.error("Erro ao consultar ViaCEP:",t),this.showNoCoverageModal()}})}showNoCoverageModal(){this.showToast("warn","\xC1rea n\xE3o atendida","No momento, este CEP n\xE3o faz parte da nossa \xE1rea de atendimento.",!0,"custom-toast",{whatsappRedirect:!0},!0),this.form.patchValue({logradouro:"",bairro:"",cidade:"",estado:"",numero:null,complemento:""}),this.form.get("numero")?.disable(),this.form.get("complemento")?.disable()}onWppButtonClick(e){window.open("https://wa.me/5531987824674","_blank")}processarCalculo(){if(this.form.invalid){this.form.markAllAsTouched();return}if(!this.authService.isAuthenticated()){this.showToast("error","Usuario n\xE3o encontrado","Por favor, cadastre-se ou efetue o login para realizar o c\xE1lculo");return}let e=this.form.getRawValue(),t={address:{street:e.logradouro,number:e.numero,neighborhood:e.bairro,city:e.cidade,state:e.estado,country:"Brasil"},areaSettings:{area_Size:e.area,unitOfMeasure:e.unitOfMeasure},confrontations:e.confrontations??0,serviceTypeId:e.servico,intentionServiceId:this.getIntentionServiceId(e.detalheServico)};console.log("Requisi\xE7\xE3o para c\xE1lculo:",t),this.budgetService.processCalc(t).subscribe({next:r=>{this.form.get("price")?.setValue(r.calcParametersResponse)},error:r=>{let d=r.error.errors.map(f=>`${f.message}`).join("<br>");this.showToast("error","Erro ao gerar valor final",d)}})}getIntentionServiceId(e){let t=this.intentions.find(r=>r.name===e);return t?t.id:0}gerarOrcamento(){if(this.form.invalid){this.form.markAllAsTouched();return}if(!this.authService.isAuthenticated()){this.showToast("error","Usuario n\xE3o encontrado","Por favor, cadastre-se ou efetue o login gerar o or\xE7amento");return}let e=this.form.getRawValue(),t=this.authService.getUserIdFromToken(),r=parseFloat(e.price.replace("R$","").replace(/\s/g,"").replace(/\./g,"").replace(",",".")),n={userId:t??0,price:Number.isNaN(r)?0:r,startDate:e.startDate,endDate:e.endDate,confrontations:e.confrontations||0,serviceTypeId:e.servico||0,intentionServiceId:this.getIntentionServiceId(e.detalheServico),budgetAreaSettings:{area_Size:e.area,unitOfMeasure:e.unitOfMeasure},address:{zipcode:e.cep,street:e.logradouro,neighborhood:e.bairro,city:e.cidade,state:e.estado,number:e.numero,complement:e.complemento}};this.budgetService.postBudget(n).subscribe({next:d=>{this.showToast("success","Sucesso","Or\xE7amento criado com sucesso!"),setTimeout(()=>{this.router.navigate([`/budget/${d.id}`])},1e3)},error:d=>{let b=d.error.errors.map(me=>`${me.message}`).join("<br>");this.showToast("error","Erro ao registrar or\xE7amento",b)}})}showToast(e,t,r,n=!1,d="",f,b=!1){this.messageService.add({severity:e,summary:t,detail:r,sticky:n,contentStyleClass:d,data:f}),this.redirectWpp=b}getBudgetById(e){this.budgetService.getAllServiceTypes().pipe(B(t=>{this.serviceTypes=t}),V(()=>this.budgetService.getBudgetById(e))).subscribe(t=>{let r=this.serviceTypes.find(n=>n.id===t.serviceType.id);this.intentions=r?.intentionServices||[],this.form.patchValue({cep:t.address.zipcode,bairro:t.address.neighborhood,logradouro:t.address.street,cidade:t.address.city,estado:t.address.state,numero:t.address.number,complemento:t.address.complement,area:t.budgetAreaSettings.area_Size,unitOfMeasure:t.budgetAreaSettings.unitOfMeasure,servico:t.serviceType.id,detalheServico:t.intentionService?.name,confrontations:t.confrontations,price:t.price}),this.form.disable()})}static \u0275fac=function(t){return new(t||i)(p(ie),p(te),p(ce),p(ae),p(y),p(de),p(oe))};static \u0275cmp=k({type:i,selectors:[["app-budget"]],standalone:!0,features:[F([y]),j],decls:49,vars:10,consts:[[3,"click"],["pTemplate","message"],[1,"bg-white","shadow-md","max-w-4xl","mx-auto","mt-10","rounded-xl","border","border-gray-200","main-form"],[1,"text-black","text-center","text-2xl","font-bold","py-3","rounded-t-xl",2,"background-color","#82c856"],[1,"p-6","space-y-6",3,"formGroup"],[1,"text-lg","font-semibold","mb-2"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],[1,"relative","w-full"],["type","text","formControlName","cep","placeholder","CEP","maxlength","8","pattern","[0-9]*",1,"input","pr-10","w-full",2,"pointer-events","auto"],[1,"fa","fa-search","absolute","right-3","top-1/2","transform","-translate-y-1/2","text-gray-500","cursor-pointer","z-10",2,"pointer-events","auto",3,"click"],["formControlName","logradouro","placeholder","Logradouro",1,"input"],["formControlName","bairro","placeholder","Bairro",1,"input"],["formControlName","cidade","placeholder","Cidade",1,"input"],["formControlName","estado","placeholder","Estado",1,"input"],["formControlName","numero","placeholder","N\xFAmero",1,"input"],["formControlName","complemento","placeholder","Complemento",1,"input"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4","items-center"],["formControlName","area","placeholder","\xC1rea do Im\xF3vel",1,"input"],[1,"flex","gap-4"],[1,"flex","items-center","gap-1"],["type","radio","formControlName","unitOfMeasure",3,"value"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],["id","servico","formControlName","servico",1,"form-control"],[3,"ngValue"],[3,"ngValue",4,"ngFor","ngForOf"],["id","detalheServico","formControlName","detalheServico",1,"form-control",3,"disabled"],[3,"ngValue",4,"ngIf"],["class","mt-4",4,"ngIf"],[1,"mt-4"],[1,"block","text-sm","font-medium","text-gray-700","mb-1"],["formControlName","price","placeholder","R$ 0,00","readonly","",1,"input","bg-gray-100","cursor-not-allowed","w-1/4"],["class","flex justify-center gap-4",4,"ngIf"],[1,"flex","flex-column","p-4",2,"flex","1"],[1,"text-center"],[1,"pi","pi-exclamation-triangle",2,"font-size","2.5rem","color","#f59e0b"],[1,"text-lg","font-bold","text-gray-800"],[1,"text-gray-600",3,"innerHTML"],[1,"flex","justify-content-center","mt-3"],["type","button","class","p-button bg-green-500 hover:bg-green-600 text-white border-none py-2 px-4 rounded-lg",3,"click",4,"ngIf"],["type","button",1,"p-button","bg-green-500","hover:bg-green-600","text-white","border-none","py-2","px-4","rounded-lg",3,"click"],["for","confrontations",1,"block","text-sm","font-medium","text-gray-700"],["type","number","formControlName","confrontations","placeholder","Informe a quantidade de confronta\xE7\xF5es",1,"input","mt-1"],[1,"flex","justify-center","gap-4"],["type","button",1,"bg-blue-500","hover:bg-blue-600","text-white","px-6","py-2","rounded-lg","font-semibold",3,"click"],["type","submit",1,"text-black","px-6","py-2","rounded-lg","font-semibold",2,"background-color","#82c856",3,"click"]],template:function(t,r){t&1&&(a(0,"p-toast",0),h("click",function(){return r.messageService.clear()}),g(1,fe,8,3,"ng-template",1),o(),a(2,"div",2)(3,"h2",3),s(4,"Or\xE7amento"),o(),a(5,"form",4)(6,"div")(7,"h3",5),s(8,"Localiza\xE7\xE3o"),o(),a(9,"div",6)(10,"div",7),m(11,"input",8),a(12,"i",9),h("click",function(){return r.getAddressByCep()}),o()(),m(13,"input",10)(14,"input",11)(15,"input",12)(16,"input",13)(17,"input",14)(18,"input",15),o()(),a(19,"div")(20,"h3",5),s(21,"\xC1rea"),o(),a(22,"div",16),m(23,"input",17),a(24,"div",18)(25,"label",19),m(26,"input",20),s(27," m\xB2 "),o(),a(28,"label",19),m(29,"input",20),s(30," ha "),o()()()(),a(31,"div")(32,"h3",5),s(33,"Qual servi\xE7o?"),o(),a(34,"div",21)(35,"select",22)(36,"option",23),s(37,"Selecione um servi\xE7o"),o(),g(38,he,2,2,"option",24),o(),a(39,"select",25),g(40,ve,2,1,"option",26)(41,be,2,2,"option",24),o(),g(42,Se,4,0,"div",27),o()(),a(43,"div")(44,"div",28)(45,"label",29),s(46,"Valor Final"),o(),m(47,"input",30),o()(),g(48,Ce,5,0,"div",31),o()()),t&2&&(l(5),c("formGroup",r.form),l(21),c("value",r.EUnitOfMeasure.SquareMeter),l(3),c("value",r.EUnitOfMeasure.Hectare),l(7),c("ngValue",0),l(2),c("ngForOf",r.serviceTypes),l(),c("disabled",!r.intentions.length),l(),c("ngIf",!r.intentions.length),l(),c("ngForOf",r.intentions),l(),c("ngIf",r.mostrarConfrontacoes),l(6),c("ngIf",!r.readonly))},dependencies:[re,W,X,Y,q,G,K,L,H,U,Z,ee,Q,J,R,P,z,le,se,ne],styles:[".input[_ngcontent-%COMP%]{border:1px solid #ccc;padding:10px;border-radius:6px;width:100%}.main-form[_ngcontent-%COMP%]{margin-bottom:20px}"]})}return i})();export{De as BudgetComponent};
